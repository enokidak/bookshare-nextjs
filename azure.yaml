# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: nextjs-demo
metadata:
  template: nextjs-demo@0.0.1-beta

services:
  bookshare-app:
    project: .
    language: ts
    host: containerapp

hooks:
  preprovision:
    shell: sh
    run: |
      # Validate environment variables
      if [ -z "$NEXTAUTH_SECRET" ]; then
        echo "NEXTAUTH_SECRET environment variable is required"
        exit 1
      fi
      
      # Generate NEXTAUTH_URL if not set for production
      if [ -z "$NEXTAUTH_URL" ] || [ "$NEXTAUTH_URL" = "http://localhost:3000" ]; then
        export NEXTAUTH_URL="https://ca-bookshare-app-${AZURE_ENV_NAME}.${AZURE_LOCATION}.azurecontainerapps.io"
        echo "Generated NEXTAUTH_URL: $NEXTAUTH_URL"
        azd env set NEXTAUTH_URL "$NEXTAUTH_URL"
      fi
  
  postprovision:
    shell: sh
    run: |
      # Setup PostgreSQL Add-on after infrastructure is provisioned
      echo "Setting up PostgreSQL Add-on..."
      ./scripts/setup-postgres-addon.sh
